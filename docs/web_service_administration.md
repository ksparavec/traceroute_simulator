# Network Reachability Web Service - Administration Guide

## Overview

The Network Reachability Web Service provides a web-based interface for the traceroute simulator, allowing users to perform network reachability tests through a secure web interface. The service generates comprehensive PDF reports that include network path traces, connectivity tests, firewall rule analysis, and visual network diagrams.

## Architecture

### Components

1. **Apache Web Server with CGI**
   - Handles HTTPS requests
   - Executes Python CGI scripts
   - Serves static content (HTML, CSS, JS)

2. **Python CGI Backend**
   - Session-based authentication
   - Input validation and sanitization
   - Command execution with virtual environment
   - PDF generation and delivery

3. **POSIX Locking Mechanism**
   - Prevents concurrent execution of network tests
   - Uses semaphores for process synchronization
   - Configurable timeout (default: 5 minutes)

4. **Data Storage**
   - File-based storage for traces, results, and PDFs
   - Session data in JSON files
   - User credentials with hashed passwords
   - Configurable retention period (default: 1 year)

### Security Features

- **HTTPS Only**: All traffic encrypted with SSL/TLS
- **Session Management**: Secure cookies (HTTPOnly, Secure, SameSite)
- **Input Validation**: Server-side validation of all inputs
- **Command Injection Prevention**: Sanitization of user inputs
- **Path Traversal Prevention**: UUID-based filenames
- **Authentication**: Username/password with PBKDF2 hashing
- **Shareable Links**: HMAC-signed tokens for PDF access

## Installation

### Prerequisites

- Apache 2.4+ with mod_cgi, mod_ssl enabled
- Python 3.8+ with virtual environment
- posix-ipc Python package
- Traceroute simulator installed and configured
- SSL certificate (self-signed or CA-issued)

### Installation Steps

1. **Create target directory**:
   ```bash
   sudo mkdir -p /var/www/traceroute-web
   ```

2. **Install web service files**:
   ```bash
   cd /path/to/traceroute_simulator
   sudo make install-web WEB_ROOT=/var/www/traceroute-web
   ```

3. **Create initial admin user**:
   ```bash
   cd /var/www/traceroute-web
   sudo -u www-data ./scripts/create_user.sh
   # Enter username and password when prompted
   ```

4. **Configure Apache**:
   ```bash
   # Copy and edit configuration
   sudo cp /var/www/traceroute-web/conf/apache-site.conf.template \
           /etc/apache2/sites-available/traceroute-web.conf
   
   # Edit server name and SSL paths
   sudo nano /etc/apache2/sites-available/traceroute-web.conf
   
   # Enable site
   sudo a2ensite traceroute-web
   sudo systemctl reload apache2
   ```

5. **Set up SSL certificate** (for testing):
   ```bash
   sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
     -keyout /etc/ssl/private/traceroute.key \
     -out /etc/ssl/certs/traceroute.crt \
     -subj "/C=US/ST=State/L=City/O=Organization/CN=traceroute.example.com"
   ```

6. **Configure cron jobs**:
   ```bash
   sudo -u www-data crontab -e
   # Add the following lines:
   0 2 * * * /usr/bin/python3 /var/www/traceroute-web/cgi-bin/cleanup.py >> /var/www/traceroute-web/logs/cleanup.log 2>&1
   0 * * * * /usr/bin/python3 -c "import sys; sys.path.append('/var/www/traceroute-web/cgi-bin/lib'); from session import SessionManager; SessionManager().cleanup_expired_sessions()"
   ```

7. **Install Python dependencies**:
   ```bash
   # In the virtual environment
   source /home/sparavec/tsim-venv/bin/activate
   pip install posix-ipc
   ```

## Configuration

### Main Configuration File

Location: `/var/www/traceroute-web/conf/config.json`

```json
{
  "data_retention_days": 365,
  "session_timeout": 3600,
  "venv_path": "/home/sparavec/tsim-venv",
  "tsimsh_path": "tsimsh",
  "traceroute_simulator_path": "/home/sparavec/git/traceroute_simulator",
  "log_level": "DEBUG",
  "secret_key": "<auto-generated>"
}
```

### Configuration Options

- **data_retention_days**: How long to keep trace/result/PDF files
- **session_timeout**: User session timeout in seconds
- **venv_path**: Path to Python virtual environment
- **tsimsh_path**: Path to tsimsh executable
- **traceroute_simulator_path**: Path to simulator directory
- **log_level**: Logging verbosity (DEBUG, INFO, WARNING, ERROR)
- **secret_key**: Secret for HMAC signing (auto-generated)

## Usage

### User Workflow

1. **Login**: Navigate to https://traceroute.example.com
2. **Enter Test Parameters**:
   - Source IP address (required)
   - Source port (optional)
   - Destination IP address (required)
   - Destination port (required)
   - Protocol: TCP or UDP
3. **Run Test**: Click "Run Test" button
4. **View Results**: PDF opens in browser
5. **Share Results**: Copy shareable link from browser URL

### Administrative Tasks

#### Create New User
```bash
cd /var/www/traceroute-web
sudo -u www-data ./scripts/create_user.sh
```

#### View Logs
```bash
# Access logs
tail -f /var/www/traceroute-web/logs/access.log

# Error logs
tail -f /var/www/traceroute-web/logs/error.log

# Audit logs (command execution)
tail -f /var/www/traceroute-web/logs/audit.log
```

#### Monitor Lock Status
```bash
# Check if lock is held
ls -la /dev/shm/sem.traceroute_network_test_lock

# Monitor lock usage
watch -n 1 'ls -la /dev/shm/sem.* 2>/dev/null'
```

#### Manual Cleanup
```bash
# Run cleanup script manually
sudo -u www-data python3 /var/www/traceroute-web/cgi-bin/cleanup.py

# Remove stale lock if needed
sudo python3 -c "import posix_ipc; posix_ipc.Semaphore('/traceroute_network_test_lock').unlink()"
```

## Directory Structure

```
/var/www/traceroute-web/
├── cgi-bin/              # CGI scripts
│   ├── login.py          # Login handler
│   ├── logout.py         # Logout handler
│   ├── main.py           # Form processor
│   ├── pdf_viewer.py     # PDF viewer
│   ├── cleanup.py        # Maintenance script
│   └── lib/              # Python libraries
├── htdocs/               # Static web content
│   ├── index.html        # Redirect to login
│   ├── login.html        # Login page
│   ├── form.html         # Test form
│   ├── css/              # Stylesheets
│   └── js/               # JavaScript
├── data/                 # Application data
│   ├── traces/           # JSON trace files
│   ├── results/          # Test results
│   ├── pdfs/             # Generated PDFs
│   ├── sessions/         # User sessions
│   └── users/            # User accounts
├── logs/                 # Log files
├── conf/                 # Configuration
└── scripts/              # Utility scripts
```

## Troubleshooting

### Common Issues

#### 1. Permission Denied Errors
```bash
# Fix ownership
sudo chown -R www-data:www-data /var/www/traceroute-web

# Fix permissions
sudo chmod -R 750 /var/www/traceroute-web/data
sudo chmod -R 750 /var/www/traceroute-web/logs
```

#### 2. Virtual Environment Not Found
- Check `venv_path` in config.json
- Ensure www-data has execute permissions on venv

#### 3. Lock Timeout Errors
- Check for stale locks in /dev/shm/
- Increase LOCK_TIMEOUT if needed
- Monitor concurrent usage

#### 4. PDF Generation Fails
- Check visualize_reachability.py dependencies
- Verify graphviz installation
- Check disk space in /var/www/traceroute-web/data/pdfs/

#### 5. Session Issues
```bash
# Clear all sessions
sudo rm -f /var/www/traceroute-web/data/sessions/*.json

# Check session directory permissions
ls -la /var/www/traceroute-web/data/sessions/
```

### Debug Mode

To enable detailed debugging:

1. Edit Apache configuration:
   ```apache
   SetEnv PYTHONUNBUFFERED 1
   SetEnv PYTHONUTF8 1
   ```

2. Check CGI error output:
   ```bash
   tail -f /var/log/apache2/error.log
   ```

3. Enable CGI display errors (temporary):
   ```python
   cgitb.enable(display=1, logdir="/var/www/traceroute-web/logs")
   ```

## Monitoring

### Performance Metrics

Monitor these key metrics:

1. **Response Time**: Check audit.log for command execution duration
2. **Lock Contention**: Monitor lock wait times in audit.log
3. **Disk Usage**: Track growth of data directories
4. **Session Count**: Monitor active sessions
5. **Error Rate**: Track errors in error.log

### Health Checks

```bash
# Check service availability
curl -k https://traceroute.example.com/login.html

# Check disk usage
df -h /var/www/traceroute-web

# Check process count
ps aux | grep -E "(apache2|python)" | wc -l

# Check log sizes
du -sh /var/www/traceroute-web/logs/*
```

## Backup and Recovery

### Backup Strategy

1. **Configuration**: `/var/www/traceroute-web/conf/`
2. **User Data**: `/var/www/traceroute-web/data/users/`
3. **Historical Data**: `/var/www/traceroute-web/data/` (optional)

### Backup Script Example

```bash
#!/bin/bash
BACKUP_DIR="/backup/traceroute-web"
WEB_ROOT="/var/www/traceroute-web"
DATE=$(date +%Y%m%d_%H%M%S)

# Create backup directory
mkdir -p "$BACKUP_DIR"

# Backup configuration and users
tar -czf "$BACKUP_DIR/traceroute-web-$DATE.tar.gz" \
  -C "$WEB_ROOT" \
  conf/ data/users/

# Keep only last 30 days of backups
find "$BACKUP_DIR" -name "traceroute-web-*.tar.gz" -mtime +30 -delete
```

### Recovery

```bash
# Restore from backup
cd /var/www/traceroute-web
tar -xzf /backup/traceroute-web/traceroute-web-20240115_120000.tar.gz

# Fix permissions
sudo chown -R www-data:www-data /var/www/traceroute-web
```

## Security Best Practices

1. **Regular Updates**
   - Keep Apache and Python packages updated
   - Review and update dependencies

2. **Access Control**
   - Use strong passwords
   - Rotate secret_key periodically
   - Limit Apache access by IP if possible

3. **Monitoring**
   - Review access.log for suspicious activity
   - Monitor failed login attempts
   - Set up alerts for errors

4. **Data Protection**
   - Enable Apache mod_security if available
   - Consider encrypting data directory
   - Regular backups of user data

## Maintenance Schedule

### Daily
- Automatic cleanup of old data (via cron)
- Monitor error logs

### Weekly
- Review disk usage
- Check for stale locks
- Analyze usage patterns

### Monthly
- Review and archive logs
- Update user accounts
- Performance analysis

### Quarterly
- Security audit
- Dependency updates
- Backup verification

## Integration

### LDAP/AD Integration

To integrate with corporate authentication:

1. Modify auth.py to support LDAP
2. Install python-ldap package
3. Configure LDAP settings in config.json

### Monitoring Integration

For integration with monitoring systems:

1. **Prometheus**: Export metrics endpoint
2. **Nagios**: Create check scripts
3. **ELK Stack**: Ship logs to Elasticsearch

### API Access

For programmatic access:

1. Create API endpoint in CGI
2. Use token-based authentication
3. Return JSON instead of HTML/PDF

## Support

For issues and questions:

1. Check logs in `/var/www/traceroute-web/logs/`
2. Review this documentation
3. Check Apache error logs
4. Verify traceroute simulator functionality
{{ ansible_managed | comment }}
# SSH authorized_keys for restricted user {{ restricted_user_name }}
# This file is managed by Ansible. Manual changes will be overwritten.
# User: {{ restricted_user_name }}
# Home: {{ user_home | default(restricted_user_home) }}
# Purpose: Restricted access for traceroute execution only (10.x.x.x targets only)
#
{% set full_command = tracersh_path %}
{% if (supports_restrict | default(false)) and ssh_restrict_option %}
# Using OpenSSH 7.2+ restrict option with explicit restrictions for defense in depth
restrict,no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty{% if ssh_from_hosts | length > 0 %},from="{{ ssh_from_hosts | join(',') }}"{% endif %},command="{{ full_command }}" {{ ssh_public_key }}
{% else %}
# Using traditional restrictions (OpenSSH < 7.2 or restrict disabled)
{% if ssh_from_hosts | length > 0 %}from="{{ ssh_from_hosts | join(',') }}",{% endif %}command="{{ full_command }}",no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty {{ ssh_public_key }}
{% endif %}
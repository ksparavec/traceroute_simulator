# Traceroute Simulator Namespace Operations
# This configuration allows tsim-users group to manage network namespaces
# while preventing access to the host namespace
#
# NOTE: The group name 'tsim-users' below should match the unix_group setting
#       in traceroute_simulator.yaml configuration file

# IMPORTANT: ip netns exec requires a namespace name, preventing host namespace access

# Namespace management operations
# Allow creating and deleting any namespace
%tsim-users ALL=(ALL) NOPASSWD: /usr/sbin/ip netns add *
%tsim-users ALL=(ALL) NOPASSWD: /usr/sbin/ip netns del *
%tsim-users ALL=(ALL) NOPASSWD: /usr/sbin/ip netns list
%tsim-users ALL=(ALL) NOPASSWD: /usr/sbin/ip netns list *

# Execute commands within namespaces
# The * after exec is the namespace name - this is required, preventing host access
%tsim-users ALL=(ALL) NOPASSWD: /usr/sbin/ip netns exec * *

# Network interface operations (for veth pairs)
# Only allow creating veth pairs and moving interfaces to namespaces
# Note: We don't allow 'ip link del' in host namespace - deletion happens via namespace cleanup
%tsim-users ALL=(ALL) NOPASSWD: /usr/sbin/ip link add * type veth peer name *
%tsim-users ALL=(ALL) NOPASSWD: /usr/sbin/ip link set * netns *

# Bridge management - only for hidden-* bridges used by simulator
%tsim-users ALL=(ALL) NOPASSWD: /usr/sbin/brctl addbr hidden-*
%tsim-users ALL=(ALL) NOPASSWD: /usr/sbin/brctl delbr hidden-*
%tsim-users ALL=(ALL) NOPASSWD: /usr/sbin/brctl addif hidden-* *
%tsim-users ALL=(ALL) NOPASSWD: /usr/sbin/brctl delif hidden-* *

# Process management for namespace-specific service processes only
%tsim-users ALL=(ALL) NOPASSWD: /usr/bin/pkill -f traceroute_simulator_service_*

# SECURITY NOTES:
# 1. The 'ip netns exec' command REQUIRES a namespace name, preventing host namespace access
# 2. Interface deletion is NOT allowed in host namespace - interfaces are cleaned up when namespace is deleted
# 3. Bridge operations are limited to hidden-* bridges only
# 4. All namespace operations are logged via sudo audit
# 5. The tsim-users group must be created and users added to it